@using Car_Rental.Models.Entities
@using Car_Rental.Enum
@model Car_Rental.Models.Entities.Booking

@{
    var car = ViewBag.SelectedCar as Car;
    ViewData["Title"] = "Complete Your Booking";
}

@section Styles {
    <style>
        .booking-card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

            .booking-card .card-header {
                background-color: #343a40;
                color: white;
                padding: 1rem 1.5rem;
                border-bottom: 5px solid #ffc107;
            }

            .booking-card .list-group-item {
                border-bottom: 1px solid #f0f0f0 !important;
                padding: 0.85rem 1.5rem;
            }

                .booking-card .list-group-item .bi {
                    color: #0d6efd;
                    margin-right: 1rem;
                    width: 20px;
                }

        .star-rating .bi-star-fill {
            color: #ffc107;
        }

        .price-display {
            font-weight: 700;
            font-size: 1.75rem;
        }

        #insuranceDescription, #driverDetails {
            display: none;
            background-color: #e9f5ff;
            border-left: 5px solid #0d6efd;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
        }

        .driver-photo-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-section-heading {
            font-weight: 600;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ffc107;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
}

@if (car == null)
{
    <div class="alert alert-danger text-center mt-5">
        <h1 class="display-4"><i class="bi bi-exclamation-triangle-fill"></i> Error: Car Not Found</h1>
        <p class="lead">The car you are trying to book is not available. Please select another car.</p>
        <a asp-controller="Guest" asp-action="Cars" class="btn btn-primary btn-lg mt-3">Back to Car List</a>
    </div>
}
else
{
    <div class="container my-5">
        <div class="text-center mb-4">
            <h1 class="fw-bold">@ViewData["Title"]</h1>
            <p class="text-muted">You're just a few steps away from hitting the road.</p>
        </div>

        <div class="row g-4 g-lg-5">
            <!-- CAR DETAILS COLUMN -->
            <div class="col-lg-5">
                <div class="booking-card sticky-top" style="top: 20px;">
                    <div class="card-header"><h4 class="mb-0">Your Selected Ride</h4></div>
                    <img src="@(string.IsNullOrEmpty(car.ImageUrl) ? "/images/default-car.png" : car.ImageUrl)" class="card-img-top">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="card-title fw-bolder mb-0">@car.Brand @car.Model</h3>
                            @if (car.Rating.HasValue)
                            {
                                <div class="star-rating">
                                    @for (int i = 0; i < car.Rating.Value; i++)
                                    {
                                        <i class="bi bi-star-fill"></i>
                                    }
                                    @for (int i = car.Rating.Value; i < 5; i++)
                                    {
                                        <i class="bi bi-star"></i>
                                    }
                                </div>
                            }
                        </div>
                        <h6 class="card-subtitle mb-3 text-muted">@car.Year Model</h6>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-tag-fill"></i>Price / day</span><strong id="pricePerDay" data-base-price="@car.RentalPricePerDay.ToString("F2")">$@car.RentalPricePerDay.ToString("F2")</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-gear-fill"></i>Transmission</span><strong>@car.Transmission</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-fuel-pump-fill"></i>Fuel</span><strong>@car.FuelType</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-people-fill"></i>Seats</span><strong>@car.NumberOfSeats</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-snow"></i>Air Conditioned</span><strong>@(car.IsAirConditioned ? "Yes" : "No")</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-speedometer2"></i>Mileage</span><strong>@car.Mileage km/l</strong></li>
                    </ul>
                    <div class="card-body">
                        <a asp-controller="Guest" asp-action="Cars" class="btn btn-outline-secondary w-100"><i class="bi bi-arrow-left-circle"></i> Change Car</a>
                    </div>
                </div>
            </div>

            <!-- BOOKING FORM COLUMN -->
            <div class="col-lg-7">
                <form asp-action="Booking" method="post" class="p-4 bg-white border rounded">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="CarID" id="CarID" value="@car.CarId" />
                    <input type="hidden" asp-for="TotalPrice" id="totalPriceInput" />

                    <h5 class="form-section-heading">Rental Dates</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label asp-for="PickupDate" class="form-label fw-bold"></label><input asp-for="PickupDate" class="form-control" id="pickupDate" type="date" /></div>
                        <div class="col-md-6 mb-3"><label asp-for="ReturnDate" class="form-label fw-bold"></label><input asp-for="ReturnDate" class="form-control" id="returnDate" type="date" /></div>
                    </div>
                    <div id="availability-message" class="alert d-none"></div>

                    <h5 class="form-section-heading">Optional Add-ons</h5>
                    <div class="mb-3">
                        <label asp-for="InsuranceID" class="form-label">Insurance</label>
                        <select asp-for="InsuranceID" class="form-select" id="insuranceSelect">
                            <option value="">None</option>
                            @foreach (var insurance in (List<Insurance>)ViewBag.Insurances)
                            {
                                <option value="@insurance.InsuranceID" data-percentage="@insurance.CoveragePercentage" data-description="@insurance.Description">@insurance.Name (+@insurance.CoveragePercentage%)</option>
                            }
                        </select>
                        <div id="insuranceDescription" class="small"></div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="DriverID" class="form-label">Driver</label>
                        <select asp-for="DriverID" class="form-select" id="driverSelect">
                            <option value="">I will drive myself</option>
                            @foreach (var driver in (List<Driver>)ViewBag.Drivers)
                            {
                                <option value="@driver.DriverID" data-fee-per-day="@driver.FeePerDay?.ToString("F2")" data-name="@driver.FullName" data-photo="@(string.IsNullOrEmpty(driver.PhotoUrl) ? "/images/default-user.png" : driver.PhotoUrl)">@driver.FullName (+ $@driver.FeePerDay?.ToString("F2") per day)</option>
                            }
                        </select>
                    </div>

                    <h5 class="form-section-heading">Your Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="guestFullName" class="form-label">Full Name</label><input type="text" name="guestFullName" class="form-control" required /></div>
                        <div class="col-md-6 mb-3"><label for="guestPhoneNumber" class="form-label">Phone Number</label><input type="tel" name="guestPhoneNumber" class="form-control" required /></div>
                    </div>
                    <div class="mb-3"><label for="guestEmail" class="form-label">Email Address</label><input type="email" name="guestEmail" class="form-control" required /></div>

                    <h5 class="form-section-heading">License Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label asp-for="DriverLicenseNumber" class="form-label"></label><input asp-for="DriverLicenseNumber" class="form-control" required /></div>
                        <div class="col-md-6 mb-3"><label asp-for="NIC" class="form-label"></label><input asp-for="NIC" class="form-control" required /></div>
                        <div class="col-md-6 mb-3"><label asp-for="LicenseExpiryDate" class="form-label"></label><input asp-for="LicenseExpiryDate" type="date" class="form-control" id="licenseExpiryDate" required /><div class="text-danger small mt-1" id="license-expiry-error" style="display:none;">License must be valid after the return date.</div></div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h5 class="alert-heading">Total Price</h5>
                        <div class="price-display" id="totalPriceDisplay">$0.00</div>
                        <div id="priceBreakdown" class="small mt-2 border-top pt-2"></div>
                    </div>
                    <button type="submit" id="confirmBookingBtn" class="btn btn-warning btn-lg w-100 fw-bold"><i class="bi bi-credit-card-fill"></i> Proceed to Payment</button>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            // This is a safety check to ensure the script only runs on this specific page.
            if ($('#CarID').length > 0) {

                const carId = $('#CarID').val();
                const pickupDateEl = $('#pickupDate');
                const returnDateEl = $('#returnDate');
                const licenseExpiryDateEl = $('#licenseExpiryDate');
                const availabilityMessageEl = $('#availability-message');
                const submitButton = $('#confirmBookingBtn');
                const insuranceSelectEl = $('#insuranceSelect');
                const driverSelectEl = $('#driverSelect');

                // --- MAIN HANDLER FOR ANY DATE CHANGE ---
                async function onDateChange() {
                    const isAvailable = await checkCarAvailability();
                    validateLicenseExpiry();
                    calculateTotalPrice();
                }

                // --- API CALL TO CHECK AVAILABILITY ---
                async function checkCarAvailability() {
                    const pickupDate = pickupDateEl.val();
                    const returnDate = returnDateEl.val();

                    if (!pickupDate || !returnDate || new Date(returnDate) <= new Date(pickupDate)) {
                        availabilityMessageEl.addClass('d-none');
                        submitButton.prop('disabled', false);
                        return true;
                    }
                    try {
                        const response = await fetch(`/Car/CheckAvailability?carId=${carId}&pickupDate=${pickupDate}&returnDate=${returnDate}`);
                        const data = await response.json();
                        if (data.isAvailable) {
                            availabilityMessageEl.removeClass('alert-danger d-none').addClass('alert-success').html('<strong>Available!</strong> This car is ready for your selected dates.').slideDown().delay(2500).slideUp();
                            submitButton.prop('disabled', false);
                            validateLicenseExpiry(); // Re-validate license after car becomes available
                            return true;
                        } else {
                            availabilityMessageEl.removeClass('alert-success d-none').addClass('alert-danger').html('<strong>Not Available!</strong> This car is booked for these dates.').slideDown();
                            submitButton.prop('disabled', true);
                            return false;
                        }
                    } catch (error) {
                        availabilityMessageEl.removeClass('alert-success d-none').addClass('alert-danger').text('Error checking availability.').slideDown();
                        submitButton.prop('disabled', true);
                        return false;
                    }
                }

                // --- UI UPDATE FUNCTIONS ---
                function updateInsuranceDetails() {
                    const selected = insuranceSelectEl.find('option:selected');
                    const container = $('#insuranceDescription');
                    const description = selected.data('description');
                    if (selected.val() && description) { container.text(description).slideDown(); } else { container.slideUp(); }
                }

                

                // --- VALIDATION FUNCTION ---
                function validateLicenseExpiry() {
                    const errorDiv = $('#license-expiry-error');
                    if (returnDateEl.val() && licenseExpiryDateEl.val()) {
                        if (new Date(licenseExpiryDateEl.val()) <= new Date(returnDateEl.val())) {
                            errorDiv.slideDown();
                            submitButton.prop('disabled', true);
                        } else {
                            errorDiv.slideUp();
                            // Only enable the button if it wasn't already disabled by the availability check
                            if (!submitButton.prop('disabled')) {
                                submitButton.prop('disabled', false);
                            }
                        }
                    }
                }

                // --- PRICE CALCULATION FUNCTION ---
                function calculateTotalPrice() {
                    const basePricePerDay = parseFloat($('#pricePerDay').data('base-price'));
                    const pickupDate = new Date(pickupDateEl.val());
                    const returnDate = new Date(returnDateEl.val());
                    let numberOfDays = 1;
                    if (returnDate > pickupDate) {
                        numberOfDays = Math.ceil((returnDate - pickupDate) / (1000 * 60 * 60 * 24));
                    }

                    let rentalTotal = numberOfDays * basePricePerDay;
                    let insuranceCost = 0;
                    if (insuranceSelectEl.val()) {
                        insuranceCost = rentalTotal * (parseFloat(insuranceSelectEl.find('option:selected').data('percentage')) / 100);
                    }
                    let driverFee = 0;
                    if (driverSelectEl.val()) {
                        driverFee = numberOfDays * parseFloat(driverSelectEl.find('option:selected').data('fee-per-day'));
                    }

                    let finalTotal = rentalTotal + insuranceCost + driverFee;

                    $('#totalPriceDisplay').text('$' + finalTotal.toFixed(2));
                    $('#totalPriceInput').val(finalTotal.toFixed(2));

                    let breakdownHtml = `<p class="mb-0">Rental (${numberOfDays} days): $${rentalTotal.toFixed(2)}</p>`;
                    if (insuranceCost > 0) breakdownHtml += `<p class="mb-0">Insurance: + $${insuranceCost.toFixed(2)}</p>`;
                    if (driverFee > 0) breakdownHtml += `<p class="mb-0">Driver Fee: + $${driverFee.toFixed(2)}</p>`;
                    $('#priceBreakdown').html(breakdownHtml);
                }

                // --- EVENT LISTENERS ---
                pickupDateEl.on('change', onDateChange);
                returnDateEl.on('change', onDateChange);
                licenseExpiryDateEl.on('change', validateLicenseExpiry);
                insuranceSelectEl.on('change', () => { updateInsuranceDetails(); calculateTotalPrice(); });
                driverSelectEl.on('change', () => { updateDriverDetails(); calculateTotalPrice(); });

                // --- INITIAL CALLS ON PAGE LOAD ---
                onDateChange();
                updateInsuranceDetails();
                updateDriverDetails();
            }
        });
    </script>
}