@using Car_Rental.Enum
@using Car_Rental.Models.Entities
@using System.Security.Claims
@model Car_Rental.Models.Entities.Booking

@{
    // Retrieve data passed from the controller via ViewBag
    var car = ViewBag.SelectedCar as Car;
    var insurances = ViewBag.Insurances as List<Insurance>;
    ViewData["Title"] = "Complete Your Booking";
    var isUserAuthenticated = User.Identity.IsAuthenticated;
}

@section Styles {
    <style>
        .booking-card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

            .booking-card .card-header {
                background-color: #343a40;
                color: white;
                padding: 1.5rem;
                border-bottom: 5px solid #ffc107;
                text-transform: uppercase;
            }

            .booking-card .list-group-item {
                border-bottom: 1px solid #f0f0f0 !important;
                padding: 0.85rem 1.5rem;
            }

                .booking-card .list-group-item .bi {
                    color: #0d6efd;
                    margin-right: 1rem;
                    width: 20px;
                }

        .star-rating .bi-star-fill {
            color: #ffc107;
        }

        .price-display {
            font-weight: 700;
            font-size: 1.75rem;
        }

        #insuranceDescription {
            display: none;
            background-color: #e9f5ff;
            border-left: 5px solid #0d6efd;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
        }

        .form-section-heading {
            font-weight: 600;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ffc107;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-car-card .card-img-container {
            width: 100%;
            aspect-ratio: 16 / 10;
            overflow: hidden;
        }

        .modal-car-card .card-img-top {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
}

@if (car == null)
{
    <div class="alert alert-danger text-center mt-5">
        <h1 class="display-4"><i class="bi bi-exclamation-triangle-fill"></i> Error: Car Not Found</h1>
        <p class="lead">The car you are trying to book is not available. Please select another car.</p>
        <a asp-controller="Guest" asp-action="Cars" class="btn btn-primary btn-lg mt-3">Back to Car List</a>
    </div>
}
else
{
    <div class="container my-5">
        <div class="text-center mb-4">
            <h1 class="fw-bold">@ViewData["Title"]</h1>
            <p class="text-muted">You're just a few steps away from hitting the road.</p>
        </div>
        <div class="row g-4 g-lg-5">
            <!-- CAR DETAILS COLUMN -->
            <div class="col-lg-5">
                <div class="booking-card sticky-top" style="top: 20px;">
                    <div class="card-header"><h4 class="mb-0">Your Selected Ride</h4></div>
                    <img src="@(string.IsNullOrEmpty(car.ImageUrl) ? "/images/default-car.png" : car.ImageUrl)" class="card-img-top">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="card-title fw-bolder mb-0">@car.Brand @car.Model</h3>
                            @if (car.Rating.HasValue)
                            {
                                <div class="star-rating">
                                    @for (int i = 0; i < car.Rating.Value; i++)
                                    {
                                        <i class="bi bi-star-fill"></i>
                                    }
                                    @for (int i = car.Rating.Value; i < 5; i++)
                                    {
                                        <i class="bi bi-star"></i>
                                    }
                                </div>
                            }
                        </div>
                        <h6 class="card-subtitle mb-3 text-muted">@car.Year Model</h6>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-tag-fill"></i>Price / day</span><strong id="pricePerDay" data-base-price="@car.RentalPricePerDay.ToString("F2")">$@car.RentalPricePerDay.ToString("F2")</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-gear-fill"></i>Transmission</span><strong>@car.Transmission</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-fuel-pump-fill"></i>Fuel</span><strong>@car.FuelType</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-people-fill"></i>Seats</span><strong>@car.NumberOfSeats</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-snow"></i>Air Conditioned</span><strong>@(car.IsAirConditioned ? "Yes" : "No")</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="bi bi-speedometer2"></i>Mileage</span><strong>@car.Mileage km/l</strong></li>
                    </ul>
                    <div class="card-body">
                        <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#changeCarModal"><i class="bi bi-arrow-left-right"></i> Change Car</button>
                    </div>
                </div>
            </div>

            <!-- BOOKING FORM COLUMN -->
            <div class="col-lg-7">
                <form id="mainBookingForm" asp-controller="Booking" asp-action="Booking" method="post" class="p-4 bg-white border rounded">
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <input type="hidden" asp-for="CarID" id="CarID" value="@car.CarId" />
                    <input type="hidden" asp-for="TotalPrice" id="totalPriceInput" />

                    <!-- விருந்தினர் விவரங்கள் இந்த மறைக்கப்பட்ட புலங்களில் சேமிக்கப்படும் -->
                    <input type="hidden" name="guestFullName" id="hiddenGuestFullName" />
                    <input type="hidden" name="guestEmail" id="hiddenGuestEmail" />
                    <input type="hidden" name="guestPhoneNumber" id="hiddenGuestPhoneNumber" />


                    <h5 class="form-section-heading">Rental Dates</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label asp-for="PickupDate" class="form-label fw-bold"></label><input asp-for="PickupDate" class="form-control" id="pickupDate" type="date" required /></div>
                        <div class="col-md-6 mb-3"><label asp-for="ReturnDate" class="form-label fw-bold"></label><input asp-for="ReturnDate" class="form-control" id="returnDate" type="date" required /></div>
                    </div>
                    <div id="availability-message" class="alert d-none"></div>

                    <h5 class="form-section-heading">Optional Add-ons</h5>
                    <div class="mb-3">
                        <label asp-for="InsuranceID" class="form-label">Insurance</label>
                        <select asp-for="InsuranceID" class="form-select" id="insuranceSelect">
                            <option value="">None</option>
                            @foreach (var insurance in insurances)
                            {
                                <option value="@insurance.InsuranceID" data-percentage="@insurance.CoveragePercentage" data-description="@insurance.Description">@insurance.Name (+@insurance.CoveragePercentage%)</option>
                            }
                        </select>
                        <div id="insuranceDescription" class="small"></div>
                    </div>

                    <!-- விருந்தினர் விவரங்கள் பிரிவு நீக்கப்பட்டது -->

                    <div id="licenseDetailsSection">
                        <h5 class="form-section-heading">Your License Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label asp-for="DriverLicenseNumber" class="form-label"></label><input asp-for="DriverLicenseNumber" class="form-control" required /></div>
                            <div class="col-md-6 mb-3"><label asp-for="NIC" class="form-label"></label><input asp-for="NIC" class="form-control" required /></div>
                            <div class="col-md-6 mb-3"><label asp-for="LicenseExpiryDate" class="form-label"></label><input asp-for="LicenseExpiryDate" type="date" class="form-control" id="licenseExpiryDate" required /><div class="text-danger small mt-1" id="license-expiry-error" style="display:none;">License must be valid after the return date.</div></div>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h5 class="alert-heading">Total Price</h5>
                        <div class="price-display" id="totalPriceDisplay">$0.00</div>
                        <div id="priceBreakdown" class="small mt-2 border-top pt-2"></div>
                    </div>
                    <button type="submit" id="confirmBookingBtn" class="btn btn-warning btn-lg w-100 fw-bold"><i class="bi bi-credit-card-fill"></i> Proceed to Payment</button>
                </form>
            </div>
        </div>
    </div>
}

<!-- "CHANGE CAR" MODAL -->
<div class="modal fade" id="changeCarModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Select a Different Car</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="availableCarsContent"></div>
        </div>
    </div>
</div>

<!-- விருந்தினர் விவரங்கள் இப்போது இந்த மாடலில் கேட்கப்படும் -->
@if (!isUserAuthenticated)
{
    <div class="modal fade" id="guestDetailsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Continue as Guest</h5>
                </div>
                <div class="modal-body">
                    <p>Please provide your details to complete the booking.</p>
                    <div id="guest-modal-error" class="alert alert-danger d-none"></div>
                    <form id="guestInfoForm">
                        <div class="mb-3">
                            <label for="modalGuestFullName" class="form-label">Full Name</label>
                            <input type="text" id="modalGuestFullName" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="modalGuestEmail" class="form-label">Email Address</label>
                            <input type="email" id="modalGuestEmail" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="modalGuestPhoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" id="modalGuestPhoneNumber" class="form-control" required />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <a asp-controller="Account" asp-action="Login" class="btn btn-secondary">Login Instead</a>
                    <button type="button" class="btn btn-warning" id="saveGuestDetailsBtn">Save and Continue</button>
                </div>
            </div>
        </div>
    </div>
}


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            if ($('#CarID').length > 0) {
                // --- ELEMENT SELECTORS ---
                const carIdEl = $('#CarID');
                const pickupDateEl = $('#pickupDate');
                const returnDateEl = $('#returnDate');
                const licenseExpiryDateEl = $('#licenseExpiryDate');
                const availabilityMessageEl = $('#availability-message');
                const insuranceSelectEl = $('#insuranceSelect');
                const changeCarModalEl = new bootstrap.Modal(document.getElementById('changeCarModal'));

                // --- MAIN HANDLER for any change that affects price or availability ---
                async function onFormChange() {
                    await checkCarAvailability();
                    calculateTotalPrice();
                }

                // --- FEATURE: "CHANGE CAR" MODAL LOGIC (இது அப்படியே இருக்கும்) ---
                $('#changeCarModal').on('show.bs.modal', async function () {
                    const pickupDate = pickupDateEl.val();
                    const returnDate = returnDateEl.val();
                    const contentDiv = $('#availableCarsContent');
                    if (!pickupDate || !returnDate) {
                        contentDiv.html('<div class="alert alert-warning">Please select your rental dates first.</div>'); return;
                    }
                    contentDiv.html('<div class="d-flex justify-content-center p-5"><div class="spinner-border text-warning"></div></div>');
                    try {
                        const response = await fetch(`/Car/GetAvailableCars?pickupDate=${pickupDate}&returnDate=${returnDate}&currentCarId=${carIdEl.val()}`);
                        const availableCars = await response.json();
                        if (availableCars.length > 0) {
                            let carsHtml = '<div class="row g-3">';
                            availableCars.forEach(car => {
                                carsHtml += `
                                    <div class="col-md-4"><div class="card h-100 text-center modal-car-card">
                                        <div class="card-img-container"><img src="${car.imageUrl || '/images/default-car.png'}" class="card-img-top"></div>
                                        <div class="card-body d-flex flex-column">
                                            <h6 class="card-title fw-bold">${car.brand} ${car.model}</h6>
                                            <div class="mt-auto">
                                                <p class="fw-bold fs-5 mb-2">$${car.rentalPricePerDay.toFixed(2)}<small class="text-muted">/day</small></p>
                                                <button class="btn btn-sm btn-warning w-100 select-car-btn" data-new-car-id="${car.carId}">Select</button>
                                            </div></div></div></div>`;
                            });
                            carsHtml += '</div>';
                            contentDiv.html(carsHtml);
                        } else { contentDiv.html('<div class="alert alert-info">No other cars are available for the selected dates.</div>'); }
                    } catch (error) { contentDiv.html('<div class="alert alert-danger">Could not load available cars.</div>'); }
                });

                $(document).on('click', '.select-car-btn', function() {
                    const newCarId = $(this).data('new-car-id');
                    window.location.href = `/Booking/Booking?carId=${newCarId}&pickupDate=${pickupDateEl.val()}&returnDate=${returnDateEl.val()}`;
                });

                // -----------------------------------------------------------------
                // --- புதிதாக சேர்க்கப்பட்ட மற்றும் மாற்றியமைக்கப்பட்ட ஜாவாஸ்கிரிப்ட் ---
                // -----------------------------------------------------------------
                const mainBookingForm = $('#mainBookingForm');
                const isUserAuthenticated = @isUserAuthenticated.ToString().ToLower();
                let guestModal = null;

                if (!isUserAuthenticated) {
                    guestModal = new bootstrap.Modal(document.getElementById('guestDetailsModal'));
                }

                mainBookingForm.on('submit', function(e) {
                    if (!isUserAuthenticated) {
                        e.preventDefault(); // படிவம் சமர்ப்பிப்பதை நிறுத்தவும்
                        guestModal.show(); // விருந்தினர் மாடலைக் காட்டவும்
                    }
                    // உள்நுழைந்திருந்தால், படிவம் சாதாரணமாக தொடரும்
                });

                $('#saveGuestDetailsBtn').on('click', function() {
                    const guestName = $('#modalGuestFullName').val();
                    const guestEmail = $('#modalGuestEmail').val();
                    const guestPhone = $('#modalGuestPhoneNumber').val();
                    const errorDiv = $('#guest-modal-error');

                    if (!guestName || !guestEmail || !guestPhone) {
                        errorDiv.text('All fields are required.').removeClass('d-none');
                        return;
                    }
                    errorDiv.addClass('d-none');

                    // விவரங்களை மறைக்கப்பட்ட புலங்களில் நிரப்பவும்
                    $('#hiddenGuestFullName').val(guestName);
                    $('#hiddenGuestEmail').val(guestEmail);
                    $('#hiddenGuestPhoneNumber').val(guestPhone);

                    guestModal.hide(); // மாடலை மறைக்கவும்

                    // முக்கிய படிவத்தைச் சமர்ப்பிக்கவும்
                    mainBookingForm.submit();
                });


                // --- CORE LOGIC FUNCTIONS (இவை அப்படியே இருக்கும்) ---
                function initializeDatePickers() {
                    const today = new Date().toISOString().split('T')[0];
                    pickupDateEl.attr('min', today);
                    pickupDateEl.on('change', () => {
                        const pickupValue = pickupDateEl.val();
                        if (pickupValue) {
                            let minReturnDate = new Date(pickupValue);
                            minReturnDate.setDate(minReturnDate.getDate() + 1);
                            returnDateEl.attr('min', minReturnDate.toISOString().split('T')[0]);
                            if (returnDateEl.val() && returnDateEl.val() <= pickupValue) returnDateEl.val('');
                        }
                    });
                }

                async function checkCarAvailability() {
                    const pickupDate = pickupDateEl.val();
                    const returnDate = returnDateEl.val();
                    if (!pickupDate || !returnDate || new Date(returnDate) <= new Date(pickupDate)) {
                        availabilityMessageEl.addClass('d-none'); return;
                    }
                    try {
                        const response = await fetch(`/Car/CheckAvailability?carId=${carIdEl.val()}&pickupDate=${pickupDate}&returnDate=${returnDate}`);
                        const data = await response.json();
                        if (data.isAvailable) {
                            availabilityMessageEl.addClass('d-none');
                        } else {
                            availabilityMessageEl.removeClass('d-none').addClass('alert-danger').html('<strong>Not Available!</strong> This car is booked. Here are some alternatives.');
                            changeCarModalEl.show();
                        }
                    } catch (error) {
                        availabilityMessageEl.removeClass('d-none').addClass('alert-danger').text('Error checking availability.');
                    }
                }

                function updateInsuranceDetails() {
                    const selected = insuranceSelectEl.find('option:selected');
                    const container = $('#insuranceDescription');
                    if (selected.val() && selected.data('description')) { container.text(selected.data('description')).slideDown(); } else { container.slideUp(); }
                }

                function calculateTotalPrice() {
                    const basePricePerDay = parseFloat($('#pricePerDay').data('base-price'));
                    const pickupDate = new Date(pickupDateEl.val());
                    const returnDate = new Date(returnDateEl.val());
                    let numberOfDays = 1;
                    if (returnDate > pickupDate) { numberOfDays = Math.ceil((returnDate - pickupDate) / (1000 * 60 * 60 * 24)); }
                    if (numberOfDays < 1) numberOfDays = 1; // குறைந்தபட்சம் ஒரு நாள்

                    let rentalTotal = numberOfDays * basePricePerDay;
                    let insuranceCost = 0;
                    if (insuranceSelectEl.val()) {
                        insuranceCost = rentalTotal * (parseFloat(insuranceSelectEl.find('option:selected').data('percentage')) / 100);
                    }

                    let finalTotal = rentalTotal + insuranceCost;
                    $('#totalPriceDisplay').text('$' + finalTotal.toFixed(2));
                    $('#totalPriceInput').val(finalTotal.toFixed(2));

                    let breakdownHtml = `<p class="mb-0">Rental (${numberOfDays} day(s)): $${rentalTotal.toFixed(2)}</p>`;
                    if (insuranceCost > 0) breakdownHtml += `<p class="mb-0">Insurance: + $${insuranceCost.toFixed(2)}</p>`;
                    $('#priceBreakdown').html(breakdownHtml);
                }

                // --- EVENT LISTENERS ---
                pickupDateEl.on('change', onFormChange);
                returnDateEl.on('change', onFormChange);
                insuranceSelectEl.on('change', () => { updateInsuranceDetails(); calculateTotalPrice(); });

                // --- INITIAL CALLS ---
                initializeDatePickers();
                onFormChange();
                updateInsuranceDetails();
            }
        });
    </script>
}