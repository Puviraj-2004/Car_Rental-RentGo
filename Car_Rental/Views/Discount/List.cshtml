@model IEnumerable<Car_Rental.Models.Entities.DiscountCode>

@{
    Layout = "_AdminLayout"; // Ensure it uses the LoginLayout
}

@{
    ViewData["Title"] = "All Discounts";
    var today = DateTime.Now;
}

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">@ViewData["Title"]</h2>
        <a asp-action="Add" class="btn btn-success btn-lg">
            <i class="bi bi-plus-circle me-1"></i> Add New Discount
        </a>
    </div>

    <!-- 🔍 Live Search + Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" id="discountSearchBox" class="form-control"
                   placeholder="Search by discount code..." />
        </div>
        <div class="col-md-3">
            <select id="discountStatusFilter" class="form-select">
                <option value="">All Status</option>
                <option value="Valid">Valid</option>
                <option value="Upcoming">Upcoming</option>
                <option value="Expired">Expired</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
    </div>

    <!-- 🔴 Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this discount code?
                </div>
                <div class="modal-footer">
                    <form id="deleteForm" method="post">
                        @Html.AntiForgeryToken()
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Yes, Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 📋 Discount Cards -->
    <div class="row g-4" id="discountList">
        @if (Model != null && Model.Any())
        {
            foreach (var discount in Model)
            {
                string status;
                if (!discount.IsActive)
                    status = "Inactive";
                else if (discount.EndDate < today)
                    status = "Expired";
                else if (discount.StartDate > today)
                    status = "Upcoming";
                else
                    status = "Valid";

                string badgeClass = status == "Valid" ? "bg-success" :
                status == "Expired" ? "bg-danger" :
                status == "Upcoming" ? "bg-warning" : "bg-secondary";

                <div class="col-md-3 discount-card-container"
                     data-code="@discount.Code.ToLower()"
                     data-status="@status">
                    <div class="discount-card">
                        <div class="discount-card-inner">

                            <!-- FRONT -->
                            <div class="discount-card-front d-flex flex-column justify-content-center align-items-center text-center">
                                <h4 class="fw-bold text-white">@discount.Code</h4>
                                <p class="text-white fs-5 mb-1">
                                    @if (discount.DiscountPercentage.HasValue)
                                    {
                                        @($"{discount.DiscountPercentage.Value:0}% OFF")
                                    }
                                    else if (discount.FixedAmountDiscount.HasValue)
                                    {
                                        @($"Save ${discount.FixedAmountDiscount.Value}")
                                    }
                                </p>
                                <span class="badge bg-warning text-dark">OFFER</span>
                            </div>

                            <!-- BACK -->
                            <div class="discount-card-back p-3 text-dark">
                                <p><strong>Start Date:</strong> @discount.StartDate.ToString("yyyy/MM/dd")</p>
                                <p><strong>End Date:</strong> @discount.EndDate.ToString("yyyy/MM/dd")</p>
                                <p><strong>Usage Limit:</strong> @discount.UsageLimit times</p>
                                <p><strong>Status:</strong> <span class="badge @badgeClass">@status</span></p>

                                <div class="d-flex justify-content-between mt-3">
                                    <a asp-action="Edit" asp-route-id="@discount.DiscountCodeId" class="btn btn-warning btn-sm px-3">Edit</a>
                                    <button type="button" class="btn btn-danger btn-sm px-3"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal"
                                            data-id="@discount.DiscountCodeId">
                                        Delete
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm px-3"
                                            data-bs-toggle="modal"
                                            data-bs-target="#sendDiscountModal-@discount.DiscountCodeId">
                                        Send
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center text-muted">
                No discounts available.
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // 🗑 Delete Modal
        var deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-id');
            var form = document.getElementById('deleteForm');
            form.setAttribute('action', '/Discount/Delete/' + id);
        });

        // 🔍 Live Filter
        const searchBox = document.getElementById("discountSearchBox");
        const statusFilter = document.getElementById("discountStatusFilter");

        function filterDiscounts() {
            let searchText = searchBox.value.toLowerCase();
            let statusValue = statusFilter.value;

            document.querySelectorAll(".discount-card-container").forEach(card => {
                let code = card.getAttribute("data-code");
                let status = card.getAttribute("data-status");

                let matchesSearch = code.includes(searchText);
                let matchesStatus = statusValue === "" || status === statusValue;

                if (matchesSearch && matchesStatus) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });
        }

        searchBox.addEventListener("keyup", filterDiscounts);
        statusFilter.addEventListener("change", filterDiscounts);
    </script>
}
