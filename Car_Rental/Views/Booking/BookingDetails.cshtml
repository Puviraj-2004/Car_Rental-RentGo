@model Car_Rental.Models.Entities.Booking
@{
    ViewData["Title"] = "Booking Details";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4><i class="fas fa-calendar-alt"></i> Booking Details</h4>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">
                            @TempData["ErrorMessage"]
                        </div>
                    }
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success">
                            @TempData["SuccessMessage"]
                        </div>
                    }

                    <!-- Booking Status -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5>Booking Reference</h5>
                                    <h3 class="text-primary">@Model.BookingReference</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5>Status</h5>
                                    <h3 class="@(Model.Status == Car_Rental.Enum.BookingStatus.Booked ? "text-success" : 
                                                Model.Status == Car_Rental.Enum.BookingStatus.Cancelled ? "text-danger" : "text-warning")">
                                        @Model.Status
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Information -->
                    <h5>Booking Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Car:</strong></td>
                                    <td>@Model.Car?.Brand @Model.Car?.Model (@Model.Car?.Year)</td>
                                </tr>
                                <tr>
                                    <td><strong>Pickup Date:</strong></td>
                                    <td>@Model.PickupDate.ToString("dddd, dd MMMM yyyy")</td>
                                </tr>
                                <tr>
                                    <td><strong>Return Date:</strong></td>
                                    <td>@Model.ReturnDate.ToString("dddd, dd MMMM yyyy")</td>
                                </tr>
                                <tr>
                                    <td><strong>Duration:</strong></td>
                                    <td>@((Model.ReturnDate - Model.PickupDate).Days) days</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Customer:</strong></td>
                                    <td>@(Model.User?.FullName ?? Model.Guest?.FullName)</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>@(Model.User?.Email ?? Model.Guest?.Email)</td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>@(Model.User?.PhoneNumber ?? Model.Guest?.PhoneNumber)</td>
                                </tr>
                                <tr>
                                    <td><strong>Total Amount:</strong></td>
                                    <td><strong class="text-success">$@Model.TotalPrice</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Driver Information -->
                    <h5 class="mt-4">Driver Information</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>License Number:</strong><br>@Model.DriverLicenseNumber</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>License Expiry:</strong><br>@Model.LicenseExpiryDate.ToString("dd MMM yyyy")</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>ID/Passport:</strong><br>@Model.NIC</p>
                        </div>
                    </div>

                    @if (Model.Insurance != null)
                    {
                        <h5 class="mt-4">Insurance Coverage</h5>
                        <p><strong>Plan:</strong> @Model.Insurance.Name</p>
                        <p><strong>Coverage:</strong> @Model.Insurance.CoveragePercentage%</p>
                    }
                </div>
            </div>
        </div>

        <!-- Actions Sidebar -->
        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button onclick="window.print()" class="btn btn-outline-primary btn-sm w-100 mb-2">
                        <i class="fas fa-print"></i> Print Details
                    </button>
                    
                    <a href="@Url.Action("MyBookings", "Booking")" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        <i class="fas fa-arrow-left"></i> Back to Search
                    </a>
                </div>
            </div>

            <!-- Extend Booking (only if not cancelled and future booking) -->
            @if (Model.Status != Car_Rental.Enum.BookingStatus.Cancelled && Model.PickupDate > DateTime.Now)
            {
                <div class="card mt-3">
                    <div class="card-header bg-success text-white">
                        <h6><i class="fas fa-calendar-plus"></i> Extend Rental</h6>
                    </div>
                    <div class="card-body">
                        <form asp-controller="Booking" asp-action="ExtendBooking" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="bookingId" value="@Model.BookingID" />
                            <input type="hidden" name="bookingReference" value="@Model.BookingReference" />
                            
                            <div class="mb-3">
                                <label class="form-label">New Return Date</label>
                                <input type="date" name="newReturnDate" class="form-control" 
                                       min="@Model.ReturnDate.ToString("yyyy-MM-dd")" required>
                            </div>
                            
                            <button type="submit" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-calendar-plus"></i> Extend Booking
                            </button>
                        </form>
                    </div>
                </div>
            }

            <!-- Cancel Booking (only if not cancelled and more than 24 hours before pickup) -->
            @if (Model.Status != Car_Rental.Enum.BookingStatus.Cancelled && Model.PickupDate > DateTime.Now.AddHours(24))
            {
                <div class="card mt-3">
                    <div class="card-header bg-danger text-white">
                        <h6><i class="fas fa-times-circle"></i> Cancel Booking</h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">
                            You can cancel this booking up to 24 hours before pickup time.
                        </p>
                        
                        <button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#cancelModal">
                            <i class="fas fa-times-circle"></i> Cancel Booking
                        </button>
                    </div>
                </div>
            }

            <!-- Pickup Information -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-map-marker-alt"></i> Pickup Location</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-1"><strong>RentGo Car Rental</strong></p>
                    <p class="small mb-1">123 Main Street, Downtown</p>
                    <p class="small mb-1">City, State 12345</p>
                    <p class="small mb-0"><i class="fas fa-phone"></i> +1 (555) 123-4567</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Cancellation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this booking?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                <p class="small text-muted">
                    Booking Reference: <strong>@Model.BookingReference</strong><br>
                    Car: <strong>@Model.Car?.Brand @Model.Car?.Model</strong><br>
                    Pickup Date: <strong>@Model.PickupDate.ToString("dd MMM yyyy")</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Booking</button>
                <form asp-controller="Booking" asp-action="CancelBooking" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="bookingId" value="@Model.BookingID" />
                    <input type="hidden" name="bookingReference" value="@Model.BookingReference" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times-circle"></i> Yes, Cancel Booking
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Set minimum date for extend booking
        document.addEventListener('DOMContentLoaded', function() {
            const extendDateInput = document.querySelector('input[name="newReturnDate"]');
            if (extendDateInput) {
                const currentReturnDate = '@Model.ReturnDate.ToString("yyyy-MM-dd")';
                const minDate = new Date(currentReturnDate);
                minDate.setDate(minDate.getDate() + 1);
                extendDateInput.setAttribute('min', minDate.toISOString().split('T')[0]);
            }
        });
    </script>

    <style>
        @@media print {
            .btn, .card-header, .modal {
                display: none !important;
            }
            .container {
                max-width: 100% !important;
            }
        }
    </style>
}
