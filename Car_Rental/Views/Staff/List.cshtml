@model IEnumerable<Car_Rental.Models.Entities.Staff>

@{
    ViewData["Title"] = "All Staff";
}

@{
    Layout = "_AdminLayout"; // Ensure it uses the LoginLayout
}


<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/list.css" asp-append-version="true" />


<div class="row-full">
    <!-- Left Column -->
    <div class="col-left">
        <!-- Header -->
        <div class="left-header d-flex justify-content-between align-items-center">
            <h2 class="fw-bold text-primary mb-0">@ViewData["Title"]</h2>
            <a asp-action="Add" class="btn btn-primary fw-bold">
                <i class="bi bi-plus-circle me-1"></i> Add Staff
            </a>
        </div>

        <!-- Stats Boxes -->
        <div class="left-stats stats-boxes">
            <div class="stats-box stats-total" id="totalStaffBox">Total Staff: 0</div>
            <div class="stats-box stats-available" id="activeStaffBox">Active: 0</div>
            <div class="stats-box stats-unavailable" id="inactiveStaffBox">Inactive: 0</div>
        </div>

        <!-- Search + Status Filter -->
        <div class="left-filter row g-2 align-items-center">
            <div class="col-md-7">
                <input type="text" id="searchBox" class="form-control" placeholder="Search by Name, Email, Role..." />
            </div>
            <div class="col-md-5">
                <select id="statusFilter" class="form-select">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
        </div>

        <!-- Staff Table -->
        <div class="table-container">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="ps-3">Photo</th>
                        <th>Details</th>
                        <th>Status</th>
                        <th>Hire Date</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var staff in Model)
                        {
                            <tr class="car-row" data-staff-id="@staff.StaffId">
                                <td class="ps-3">
                                    <img src="@(string.IsNullOrEmpty(staff.PhotoUrl) ? "/images/default-staff.png" : staff.PhotoUrl)" class="car-thumb" />
                                </td>
                                <td>
                                    <div class="fw-bold">@staff.FullName</div>
                                    <small class="text-muted">@staff.Email | @staff.Role</small>
                                </td>
                                <td>
                                    <span class="badge @(staff.IsActive ? "bg-success" : "bg-secondary")">
                                        @(staff.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>@staff.HireDate.ToString("yyyy-MM-dd")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="4" class="text-center p-5 text-muted">No staff members found.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-right" id="detailsPane">
        <div class="details-content text-center pt-5">
            <i class="bi bi-person-badge" style="font-size: 5rem; color: #ccc;"></i>
            <h5 class="mt-3 text-muted">No Staff Selected</h5>
            <p>Select a staff member from the list to view full details.</p>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Are you sure you want to delete this staff member?</div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rows = document.querySelectorAll(".car-row");
        const detailsPane = document.getElementById("detailsPane");
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const deleteForm = document.getElementById('deleteForm');

        // ---------------- Staff Stats ----------------
        const totalStaff = @Model.Count();
        const activeStaff = @Model.Count(s => s.IsActive);
        const inactiveStaff = totalStaff - activeStaff;

        document.getElementById("totalStaffBox").innerText = `Total Staff: ${totalStaff}`;
        document.getElementById("activeStaffBox").innerText = `Active: ${activeStaff}`;
        document.getElementById("inactiveStaffBox").innerText = `Inactive: ${inactiveStaff}`;

        // ---------------- Row Click ----------------
        rows.forEach(row => {
            row.addEventListener("click", function () {
                const staffId = this.dataset.staffId;
                const isActive = this.classList.contains("active");

                rows.forEach(r => r.classList.remove("active"));

                if (isActive) {
                    // Reset details pane
                    detailsPane.innerHTML = `<div class="details-content text-center pt-5">
                        <i class="bi bi-person-badge" style="font-size:5rem;color:#ccc;"></i>
                        <h5 class="mt-3 text-muted">No Staff Selected</h5>
                        <p>Select a staff member from the list to view full details.</p>
                    </div>`;
                } else {
                    this.classList.add("active");
                    fetch(`/Staff/GetStaffDetails/${staffId}`)
                        .then(res => res.json())
                        .then(staff => {
                            detailsPane.innerHTML = `
                                <div class="details-content">
                                    <img src="${staff.photoUrl || '/images/default-staff.png'}" alt="${staff.fullName}" />
                                    <h4 class="mb-3">${staff.fullName}</h4>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"><strong>Email:</strong> ${staff.email}</li>
                                        <li class="list-group-item"><strong>Phone:</strong> ${staff.phoneNumber}</li>
                                        <li class="list-group-item"><strong>Role:</strong> ${staff.role}</li>
                                        <li class="list-group-item"><strong>Status:</strong> ${staff.isActive ? "Active" : "Inactive"}</li>
                                        <li class="list-group-item"><strong>Hire Date:</strong> ${staff.hireDate}</li>
                                        <li class="list-group-item"><strong>Salary:</strong> $${staff.salary}</li>
                                        <li class="list-group-item"><strong>Address:</strong> ${staff.address}</li>
                                    </ul>
                                    <div class="mt-4">
                                        <a href="/Staff/Edit/${staff.staffId}" class="btn btn-warning fw-bold">Edit</a>
                                        <button type="button" class="btn btn-outline-danger fw-bold delete-btn" data-staff-id="${staff.staffId}">Delete</button>
                                    </div>
                                </div>`;
                        });
                }
            });
        });

        // ---------------- Delete Button ----------------
        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("delete-btn")) {
                const staffId = e.target.getAttribute("data-staff-id");
                deleteForm.action = `/Staff/Delete/${staffId}`;
                deleteModal.show();
            }
        });

        // ---------------- Search & Filter ----------------
        const searchBox = document.getElementById("searchBox");
        const statusFilter = document.getElementById("statusFilter");

        function filterStaff() {
            const search = searchBox.value.toLowerCase();
            const statusVal = statusFilter.value;

            rows.forEach(row => {
                const details = row.cells[1].innerText.toLowerCase();
                const statusText = row.cells[2].innerText.trim();

                const matchSearch = details.includes(search);
                const matchStatus = statusVal === "" || statusText === statusVal;

                row.style.display = (matchSearch && matchStatus) ? "" : "none";
            });

            // Reset active if filtered out
            const activeRow = document.querySelector(".car-row.active");
            if (activeRow && activeRow.style.display === "none") {
                activeRow.classList.remove("active");
                detailsPane.innerHTML = `<div class="details-content text-center pt-5">
                    <i class="bi bi-person-badge" style="font-size: 5rem; color: #ccc;"></i>
                    <h5 class="mt-3 text-muted">No Staff Selected</h5>
                    <p>Select a staff member from the list to view full details.</p>
                </div>`;
            }
        }

        searchBox.addEventListener("keyup", filterStaff);
        statusFilter.addEventListener("change", filterStaff);
    });
</script>
