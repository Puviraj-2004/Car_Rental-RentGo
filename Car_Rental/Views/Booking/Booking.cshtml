@model IEnumerable<Car_Rental.Models.Entities.Booking>
@{
    ViewData["Title"] = "Reservations Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    // Array of colors for user avatars to cycle through
    var avatarColors = new[] { "bg-primary", "bg-success", "bg-info", "bg-warning", "bg-danger", "bg-dark" };
}

<!-- Add CSRF Token for AJAX requests -->
@Html.AntiForgeryToken()

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Reservations Dashboard</h1>
            <p class="text-muted">A colorful way to manage and monitor all booking reservations.</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats-colorful bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-uppercase mb-0 opacity-75">Total Reservations</h5>
                            <span class="h2 font-weight-bold mb-0">@ViewBag.TotalBookings</span>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-calendar-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats-colorful bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-uppercase mb-0 opacity-75">Pending Approval</h5>
                            <span class="h2 font-weight-bold mb-0">@ViewBag.PendingBookings</span>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats-colorful bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-uppercase mb-0 opacity-75">Active Bookings</h5>
                            <span class="h2 font-weight-bold mb-0">@ViewBag.ActiveBookings</span>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-car fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats-colorful bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-uppercase mb-0 opacity-75">Completed</h5>
                            <span class="h2 font-weight-bold mb-0">@ViewBag.CompletedBookings</span>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservations Table -->
    <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-colorful text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-stream me-2"></i>All Reservations</h6>
                <form method="get" asp-action="Booking" class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm" name="search" value="@ViewBag.Search" placeholder="Search...">
                    <select class="form-select form-select-sm" name="status" onchange="this.form.submit()" style="max-width: 150px;">
                        <option value="">All Statuses</option>
                        <option value="pending" selected="@(ViewBag.Status == "pending")">Pending</option>
                        <option value="Booked" selected="@(ViewBag.Status == "Booked")">Booked</option>
                        <option value="Completed" selected="@(ViewBag.Status == "Completed")">Completed</option>
                        <option value="Cancelled" selected="@(ViewBag.Status == "Cancelled")">Cancelled</option>
                    </select>
                </form>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="reservationsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Customer</th>
                            <th>Vehicle</th>
                            <th>Pickup Date</th>
                            <th>Return Date</th>
                            <th>Total Price</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model)
                        {
                            var avatarColor = avatarColors[booking.BookingID % avatarColors.Length];
                            <tr>
                                <td>
                                    <h6 class="mb-0 text-primary fw-bold">@booking.BookingReference</h6>
                                    <small class="text-muted">@booking.BookingDate.ToString("MMM dd, yyyy")</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3">
                                            <div class="avatar-title @avatarColor text-white rounded-circle">
                                                @((booking.User?.FullName ?? booking.Guest?.FullName ?? "G").Substring(0, 1).ToUpper())
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@(booking.User?.FullName ?? booking.Guest?.FullName ?? "Guest User")</h6>
                                            <small class="text-muted">@(booking.User != null ? "Registered" : "Guest")</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <h6 class="mb-0">@booking.Car?.Brand @booking.Car?.Model</h6>
                                    <small class="text-muted">@booking.Car?.RegistrationNumber</small>
                                </td>
                                <td>@booking.PickupDate.ToString("MMM dd, yyyy")</td>
                                <td>@booking.ReturnDate.ToString("MMM dd, yyyy")</td>
                                <td><h6 class="mb-0 fw-bold">$@booking.TotalPrice</h6></td>
                                <td class="text-center">
                                    @switch (booking.Status)
                                    {
                                        case Car_Rental.Enum.BookingStatus.pending:
                                            <span class="badge bg-warning text-dark">Pending</span>
                                            break;
                                        case Car_Rental.Enum.BookingStatus.Booked:
                                            <span class="badge bg-success">Active</span>
                                            break;
                                        case Car_Rental.Enum.BookingStatus.Completed:
                                            <span class="badge bg-info">Completed</span>
                                            break;
                                        case Car_Rental.Enum.BookingStatus.Cancelled:
                                            <span class="badge bg-danger">Cancelled</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">Unknown</span>
                                            break;
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails(@booking.BookingID)" title="View Details"><i class="fas fa-eye"></i></button>
                                        @if (booking.Status == Car_Rental.Enum.BookingStatus.pending || booking.Status == Car_Rental.Enum.BookingStatus.Booked)
                                        {
                                            <button class="btn btn-sm btn-outline-danger" onclick="showCancelModal(@booking.BookingID, '@booking.BookingReference')" title="Cancel"><i class="fas fa-times"></i></button>
                                        }
                                        <button class="btn btn-sm btn-outline-info" onclick="contactCustomer('@(booking.User?.Email ?? booking.Guest?.Email)')" title="Contact"><i class="fas fa-envelope"></i></button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Booking Details Modal -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-gradient-colorful text-white">
                <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Booking Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="bookingDetailsContent">
                <!-- Content will be loaded here via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printBookingDetails()"><i class="fas fa-print me-2"></i>Print</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Booking Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Cancellation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel booking <strong id="cancelBookingRef" class="text-danger"></strong>? This action cannot be undone.</p>
                <div class="form-group">
                    <label for="cancelReason" class="form-label">Reason for Cancellation (Optional)</label>
                    <textarea class="form-control" id="cancelReason" rows="3" placeholder="Enter reason..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Booking</button>
                <button type="button" class="btn btn-danger" onclick="confirmCancelBooking()">Confirm Cancellation</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        let currentBookingId = null;

        $(document).ready(function() {
            $('#reservationsTable').DataTable({
                "pageLength": 10,
                "order": [[ 0, "desc" ]], // Sort by the first column (Reference) in descending order
                "columnDefs": [
                    { "orderable": false, "targets": 7 } // Disable sorting on the 'Actions' column
                ]
            });
        });

        function viewBookingDetails(bookingId) {
            const contentEl = document.getElementById('bookingDetailsContent');
            contentEl.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;

            fetch(`/Booking/GetBookingDetails/${bookingId}`)
                .then(response => response.json())
                .then(data => {
                    const statusConfig = getStatusConfig(data.status);

                    contentEl.innerHTML = `
                        <div class="text-center mb-4">
                            <h4>Reference: <span class="text-primary fw-bold">${data.bookingReference}</span></h4>
                            <span class="badge fs-6 ${statusConfig.badgeClass}">${data.status}</span>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-car me-2"></i>Vehicle</h6>
                                    </div>
                                    <div class="card-body">
                                        <h5>${data.car.brand} ${data.car.model}</h5>
                                        <p class="text-muted mb-1">Year: ${data.car.year}</p>
                                        <p class="text-muted">Reg: ${data.car.registrationNumber}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Customer</h6>
                                    </div>
                                    <div class="card-body">
                                        <h5>${data.customer.name}</h5>
                                        <p class="text-muted mb-1">${data.customer.email}</p>
                                        <p class="text-muted">${data.customer.phone}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Timeline</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Pickup:</strong> ${data.pickupDate}</p>
                                        <p class="mb-0"><strong>Return:</strong> ${data.returnDate}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment</h6>
                                    </div>
                                    <div class="card-body">
                                        <h5>Total: <span class="fw-bold text-success">$${data.totalPrice}</span></h5>
                                        <p class="mb-0"><strong>Status:</strong> ${data.paymentStatus}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
                })
                .catch(error => {
                    console.error('Error fetching booking details:', error);
                    contentEl.innerHTML = `<div class="alert alert-danger">Failed to load booking details. Please try again.</div>`;
                });
        }

        function getStatusConfig(status) {
            switch(status.toLowerCase()) {
                case 'pending': return { badgeClass: 'bg-warning text-dark' };
                case 'booked': return { badgeClass: 'bg-success' };
                case 'completed': return { badgeClass: 'bg-info' };
                case 'cancelled': return { badgeClass: 'bg-danger' };
                default: return { badgeClass: 'bg-secondary' };
            }
        }

        function printBookingDetails() {
            const printContent = document.getElementById('bookingDetailsContent').innerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            location.reload(); // Reload to restore event listeners and original state
        }

        function showCancelModal(bookingId, bookingRef) {
            currentBookingId = bookingId;
            document.getElementById('cancelBookingRef').textContent = bookingRef;
            document.getElementById('cancelReason').value = '';
            new bootstrap.Modal(document.getElementById('cancelBookingModal')).show();
        }

        function confirmCancelBooking() {
            if (!currentBookingId) return;

            const reason = document.getElementById('cancelReason').value;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const formData = new FormData();
            formData.append('bookingId', currentBookingId);
            formData.append('reason', reason);

            fetch('/Booking/AdminCancelBooking', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token
                },
                body: formData
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    alert('Booking cancelled successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            }).catch(error => {
                console.error('Error cancelling booking:', error);
                alert('An error occurred. Please try again.');
            });
        }

        function contactCustomer(email) {
            if (email) {
                window.location.href = `mailto:${email}`;
            } else {
                alert('No email address is available for this customer.');
            }
        }
    </script>
}

@section Styles {
    <style>
        /* Colorful Stat Cards */
        .card-stats-colorful {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
        }

            .card-stats-colorful:hover {
                transform: translateY(-5px);
                box-shadow: 0 1rem 3rem rgba(0,0,0,.175);
            }

            .card-stats-colorful .icon-circle {
                background-color: rgba(255, 255, 255, 0.2);
                width: 60px;
                height: 60px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

        /* Gradient Header */
        .bg-gradient-colorful {
            background: #4e54c8;
            background: -webkit-linear-gradient(to right, #8f94fb, #4e54c8);
            background: linear-gradient(to right, #8f94fb, #4e54c8);
        }

        /* Avatar Styles */
        .avatar-sm {
            width: 2.5rem;
            height: 2.5rem;
        }

        .avatar-title {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 1rem;
            font-weight: 600;
        }

        /* Table Style */
        .table {
            border-collapse: separate;
            border-spacing: 0 5px; /* Adds space between rows */
        }

            .table thead th {
                border: none;
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .table tbody tr {
                box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
                border-radius: 0.375rem; /* Match Bootstrap's default border-radius */
                overflow: hidden;
            }

            .table tbody td {
                background-color: #fff;
                border-top: 1px solid #dee2e6;
                border-bottom: 1px solid #dee2e6;
            }

                .table tbody td:first-child {
                    border-left: 1px solid #dee2e6;
                    border-top-left-radius: 0.375rem;
                    border-bottom-left-radius: 0.375rem;
                }

                .table tbody td:last-child {
                    border-right: 1px solid #dee2e6;
                    border-top-right-radius: 0.375rem;
                    border-bottom-right-radius: 0.375rem;
                }

        /* Modal Enhancements */
        .modal-header .modal-title {
            font-weight: 600;
        }

        .modal-content {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        }
    </style>
}